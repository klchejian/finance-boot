<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>台账管理</title>
<link rel="stylesheet" type="text/css" href="/static/jquery-easyui-1.3.3/themes/default/easyui.css"/>
<link rel="stylesheet" type="text/css" href="/static/jquery-easyui-1.3.3/themes/icon.css"/>
<script type="text/javascript" src="/static/jquery-easyui-1.3.3/jquery.min.js"></script>
<script type="text/javascript" src="/static/jquery-easyui-1.3.3/jquery.easyui.min.js"></script>
<script type="text/javascript" src="/static/jquery-easyui-1.3.3/locale/easyui-lang-zh_CN.js"></script>
<script type="text/javascript" src="/static/js/basicFun.js"></script>
<script type="text/javascript">

	var ledgerList = [];
	var contractIdonLedger = 0;

	$(function(){

		searchContract();
		searchLedger(1);
		$("#dg").datagrid({
			//双击事件
			onDblClickRow: function (index, row) {

				searchLedger(row.id);

			}
		});
	})
	
	function closeGoodsTypeChooseDialog(){
		$("#dlg2").dialog("close");
	}
	
	function searchContract(){
		clearGrid("dg");
		var geturl = "/api/v1/contracts?test=test";
		if($("#filterStartTime").datebox("getValue")!=""){
			geturl+="&filterStartTime="+dateToLong($("#filterStartTime").datebox("getValue"));
		}
		if($("#filterEndTime").datebox("getValue")!=""){
			geturl+="&filterEndTime="+dateToLong($("#filterEndTime").datebox("getValue"));
		}
		if($("#contractVersion").val()!=""){
			geturl+="&contractVersion="+$("#contractVersion").val();
		}
		if($("#buildingStartSize").val()!=""){
			geturl+="&buildingStartSize="+$("#buildingStartSize").val();
		}
		if($("#buildingEndSize").val()!=""){
			geturl+="&buildingEndSize="+$("#buildingEndSize").val();
		}
		if($("#signMode").val()!=""){
			geturl+="&signMode="+$("#signMode").val();
		}
		if($("#contractStatus").val()!=""){
			geturl+="&contractStatus="+$("#contractStatus").val();
		}

		$.ajax({
			url: geturl,
			type: 'GET',
			contentType: 'application/json',
			success: function (data) {
				if (data.length > 0) {
					for(var i = 0; i<data.length;i++) {
						$('#dg').datagrid('appendRow', {
							id:data[i].id,
							contractNo:data[i].contractNo,
							contractVersion:data[i].contractVersion,
							buildingInfo:data[i].buildingInfo,
							buildingSize:data[i].buildingSize,
							merchantName:data[i].merchantName,
							subscriptionDate:getMoth(data[i].subscriptionDate),
							signingDate:getMoth(data[i].signingDate),
							detailButton:'<a href=\"javascript:openCalculateBacRent(\''+ data[i].id +'\',\''+data[i].contractNo+'\')\" class=\"easyui-linkbutton\" iconCls=\"icon-search\" plain=\"true\">计算<\/a>',
							region:data[i].region,
							signer:data[i].signer,
							signingMode:data[i].signingMode,
							originalPrice:data[i].originalPrice,
							totalPrice:data[i].totalPrice,
							signTotalPrice:data[i].signTotalPrice,
							leasebackPrice:data[i].leasebackPrice,
							backPremium:data[i].backPremium,
							payStartDate:getMoth(data[i].payStartDate),
							contractTerDate:getMoth(data[i].contractTerDate),
							paybackDate:getMoth(data[i].paybackDate),
							beneficiary:data[i].beneficiary.merchantName,
							proposalId:data[i].proposalId,
							contractStatus:data[i].contractStatus,
							tariff:data[i].tariff,
							taxAmount:data[i].taxAmount
						});
					}
				}
				$.messager.alert(' ','<font size=\"2\" color=\"#666666\"><strong>查询到' +data.length+
						'条记录</strong></font>','infoSunnyIcon',
						function(){
						});
				setTimeout(function(){ $(".messager-body").window('close'); },1000);
			},
			error: function () {
				alert('An error has occured!! :-(')
			}
		})
	}

	function searchLedger(contractId){
		contractIdonLedger = contractId;
		clearGrid("dg3");
		ledgerList = [];
		var geturl = "/api/v1/ledgers/"+contractId;
		$.ajax({
			url: geturl,
			type: 'GET',
			contentType: 'application/json',
			success: function (data) {
				if (data.length > 0) {
					for(var i = 0; i<data.length;i++) {
						data[i].planPayDate = getMoth(data[i].planPayDate);

						if(data[i].payStatus=='UNPAID'){
							data[i].payStatus="未支付"
						}
						if(data[i].payStatus=='SUCCESSFULPAID'){
							data[i].payStatus="支付成功"
						}
						if(data[i].payStatus=='FAILEDPAID'){
							data[i].payStatus="支付失败"
						}
						if(data[i].actualPayDate==null || data[i].actualPayDate==0){
							data[i].actualPayDate="尚未支付";
						}else{
							data[i].actualPayDate = getMoth(data[i].actualPayDate);
						}
						if(data[i].actualPayCount==null || data[i].actualPayCount==0){
							data[i].actualPayCount="尚未支付";
						}
						ledgerList.push(data[i]);
						$('#dg3').datagrid('appendRow',data[i]);
					}
				}
				$.messager.alert(' ','<font size=\"2\" color=\"#666666\"><strong>查询到' +data.length+
						'条台账记录</strong></font>','infoSunnyIcon',
						function(){
						});
				setTimeout(function(){ $(".messager-body").window('close'); },1000);
			},
			error: function () {
				alert('An error has occured!! :-(')
			}
		})
	}



	function clearGrid(gridId){
		var item = $( '#'+gridId).datagrid('getRows');
		if (item) {
			for (var i = item.length - 1; i >= 0; i--) {
				var index = $( '#'+gridId).datagrid('getRowIndex', item[i]);
				$( '#'+gridId).datagrid('deleteRow', index);
			}
		}
	}

	function addLedger(row){
		$('#dg3').datagrid('appendRow', {
			planPayDate:row.planPayDate,
			planPayCount:row.planPayCount,
			actualPayDate:row.actualPayDate,
			actualPayCount:row.actualPayCount
		});
	}

	function openAddLedgers(){
		$("#addledgers").dialog("open").dialog("setTitle","台账导入");
	}
	function doUpload() {
		var formData = new FormData($( "#uploadForm" )[0]);
		$.ajax({
			url: '/api/v1/upload-ledgers' ,
			type: 'POST',
			data: formData,
			async: false,
			cache: false,
			contentType: false,
			processData: false,
			success: function (returndata) {
				$.messager.alert("上传成功",'');
				$("#addledgers").dialog("close");
				if(contractIdonLedger>0) {
					searchLedger(contractIdonLedger);
				}
			},
			error: function (returndata) {
				$.messager.alert("上传失败",returndata);
				$("#addledgers").dialog("close");
			}
		});
	}

	function filterLedger(){
		clearGrid("dg3");



		for(var i = 0; i<ledgerList.length;i++) {
			var validbool = true;
			if($("#payStatus").val() != "" && ledgerList[i].payStatus != $("#payStatus").val() ){
				 validbool=false;
			}
			var startDate = new Date($("#payStartDate").datebox("getValue"));

			var endDate = new Date($("#payEndDate").datebox("getValue"));
			var planPayDate =  new Date(ledgerList[i].planPayDate);

			if( planPayDate < startDate||endDate < planPayDate ){
				validbool=false;
			}

			if(validbool){
				$('#dg3').datagrid('appendRow', ledgerList[i]);
			}
		}
	}
</script>
</head>
<!--<body style="margin: 1px">-->


<body class="easyui-layout" style="margin: 1px">
<div region="north" style="height: 250px;">
	<table id="dg"  class="easyui-datagrid" fit=true
		   fitColumns="true"  rownumbers="true" singleSelect="true"
		   toolbar="#tb" >
		<thead>
		<tr>
			<th hidden="true" field="id" width="30" align="center">合同ID</th>
			<th field="contractNo" width="30" align="center">合同编号</th>
			<th field="contractVersion" width="20" align="center">合同版本</th>
			<th field="buildingInfo" width="50" align="center" >楼层房号</th>
			<th field="buildingSize" width="50" align="center" >建筑面积(m2)</th>
			<th field="beneficiary" width="40" align="center" >受益人信息</th>
			<th field="subscriptionDate" width="50" align="center">认购日期</th>
			<th field="signingDate" width="50" align="center" >签约日期</th>
			<th hidden="true" field="region" width="40" align="center" >所在区域</th>
			<th hidden="true" field="signingMode" width="40" align="center" >签约方式</th>
			<th hidden="true" field="originalPrice" width="40" align="center" >销售原价(元)</th>
			<th hidden="true" field="totalPrice" width="40" align="center" >总价(元)</th>
			<th hidden="true" field="signTotalPrice" width="40" align="center" >签约总价(元)</th>
			<th hidden="true" field="leasebackPrice" width="40" align="center" >返租基价(元)</th>
			<th hidden="true" field="backPremium" width="40" align="center" >返租溢价(元)</th>
			<th hidden="true" field="payStartDate" width="40" align="center" >记租起始时日期</th>
			<th hidden="true" field="contractTerDate" width="40" align="center" >合同期</th>
			<th hidden="true" field="paybackDate" width="40" align="center" >回款时间</th>
			<th hidden="true" field="signer" width="50" align="center" >商户姓名</th>
			<th hidden="true" field="proposalId" width="40" align="center" >方案</th>
			<th hidden="true" field="contractStatus" width="40" align="center" >合同状态</th>
			<th hidden="true" field="tariff" width="40" align="center" >税率</th>
			<th hidden="true" field="taxAmount" width="40" align="center" >个税金额(元)</th>
		</tr>
		</thead>
	</table>

	<div id="tb">
		<div style="padding-bottom: 5px">
			<fieldset style="border-color: #E7F0FF">
				<legend>台账</legend>
				<table align="center" width="100%">
					<tr>
						<td style="width: 8%;">合同版本：</td>
						<td style="width: 17%;"><select type="text" id="contractVersion" name="contractVersion" style="width: 80%" >
							<option value="">所有版本</option>
							<option value="1">1</option>
							<option value="2">2</option>
							<option value="3">3</option>
							<option value="4">4</option>
						</select></td>
						<td style="width: 8%;">签约日期：</td>
						<td  style="width: 20%;"><input type="text" id="filterStartTime" name="filterStartTime"  style="width: 84%" class="easyui-datebox"/>-<input type="text" id="filterEndTime" name="filterEndTime" style="width: 84%" class="easyui-datebox"/></td>
						<td style="width: 8%;">建筑面积：</td>
						<td style="width: 10%;"><input type="text" id="buildingStartSize" name="buildingStartSize" style="width: 40%"/>-<input type="text" id="buildingEndSize" name="buildingEndSize" style="width: 40%"/></td>
						<td style="width: 12%;"></td>
					</tr>
					<tr>
						<td>合同状态：</td>
						<td><select type="text" id="contractStatus" name="contractStatus" style="width:80%" >
							<option value="">所有状态</option>
							<option value="UNSTARTED">未开始</option>
							<option value="PENDINGRENTAL">已签约，市场培育期</option>
							<option value="RENTAL">已签约，返租期</option>
							<option value="NORMALEND">正常结束</option>
							<option value="ABNORMALEND">非正常结束</option>
						</select></td>
						<td>签约方式：</td>
						<td><select type="text" id="signMode" name="signMode" style="width: 72%" >
							<option value="">所有方式</option>
							<option value="MORTGAGE">按揭贷款</option>
							<option value="DISPOSABLE">一次性</option>
						</select></td>
						<td style="width: 8%;">房号信息：</td>
						<td><input type="text" id="buildingInfo" name="buildingInfo" style="width: 90%"/></td>
						<td></td>
					</tr>
					<tr>
						<td>合同编号:</td>
						<td><input type="text" id="contractNo" name="contractNo" style="width: 80%"/></td>
						<td>受益人姓名:</td>
						<td><input type="text" id="benefitName" name="benefitName" style="width: 70%"/></td>
						<td>受益人电话:</td>
						<td><input type="text" id="benefitPhone" name="benefitPhone" style="width: 90%"/></td>
						<td>
							<a href="javascript:searchContract()" class="easyui-linkbutton" iconCls="icon-search" plain="true">搜索</a>

						</td>
					</tr>
				</table>


				<!--&nbsp;合同编号&nbsp;<input type="text" id="contractNo" name="contractNo" style="width: 90px;"/>-->
				<!--&nbsp;姓&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;名：&nbsp;<input type="text" id="signer" name="signer" style="width: 90px;"/>-->
				<!--&nbsp;手机号：&nbsp;<input type="text" id="phone" name="phone" style="width: 90px;"/>-->
				<!--<a href="javascript:searchContract()" class="easyui-linkbutton" iconCls="icon-search" plain="true">搜索</a>-->
			</fieldset>
		</div>
	</div>
</div>
<div region="center" style="margin-top: 5px;">
	<table id="dg3"  class="easyui-datagrid" fit=true
		   fitColumns="true"  rownumbers="true" singleSelect="true" toolbar="#tb2">
		<thead>
		<tr>
			<th field="id" width="30" hidden=true align="center">编号</th>
			<th field="planPayDate" width="20" align="center">计划支付时间</th>
			<th field="planPayCountPre" width="20" align="center">税前计划支付金额(元)</th>
			<th field="planPayCountPost" width="20" align="center">税后计划支付金额(元)</th>
			<th field="actualPayDate" width="20" align="center">实际支付时间</th>
			<th field="actualPayCount" width="20" align="center">实际支付金额(元)</th>
			<th field="payStatus" width="20" align="center">支付状态</th>
			<!--<th field="bankInfo" width="50" align="center" >开户行</th>-->
			<!--<th field="bankAccount" width="50" align="center" formatter="formatPurchasingPrice">开户行账号</th>-->
		</tr>
		</thead>
	</table>

	<div id="tb2">
		<div style="padding-bottom: 0px">
			<fieldset style="border-color: #E7F0FF">
				<legend>台账筛选</legend>
				<table align="center" width="100%">
					<tr>
						<td style="width: 8%;">支付状态：</td>
						<td style="width: 20%;"><select type="text" id="payStatus" name="signMode" style="width: 72%" onchange="filterLedger()">
							<option value="">所有状态</option>
							<option value="支付成功">支付成功</option>
							<option value="未支付">未支付</option>
							<option value="支付失败">支付失败</option>
						</select></td>
						<td style="width: 8%;">计划支付时间：</td>
						<td  style="width: 20%;"><input type="text" id="payStartDate" name="payStartDate"  style="width: 84%" class="easyui-datebox" data-options="onSelect:filterLedger"/>-<input type="text" id="payEndDate" name="payEndDate" style="width: 84%" class="easyui-datebox" data-options="onSelect:filterLedger"   /></td>
						<td>
							<a href="javascript:filterLedger()" class="easyui-linkbutton" iconCls="icon-search" plain="true">筛选</a>
							<a href="javascript:openAddLedgers()" class="easyui-linkbutton" iconCls="icon-folder">台账导入</a>
						</td>
					</tr>
				</table>
			</fieldset>
		</div>
	</div>

</div>
<div id="addledgers" class="easyui-dialog" style="width:450px;height:100px;padding: 10px 10px"
	 closed="true">
	<div  align="center">
		<form id= "uploadForm">
			<input type="file" name="ledgers"/><input type="button" value="上传" onclick="doUpload()" />
		</form>
	</div>
</div>

</body>

</html>