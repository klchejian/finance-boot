<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>进货单据查询</title>
	<link rel="stylesheet" type="text/css" href="/static/jquery-easyui-1.3.3/themes/default/easyui.css"></link>
	<link rel="stylesheet" type="text/css" href="/static/jquery-easyui-1.3.3/themes/icon.css"></link>
	<script type="text/javascript" src="/static/jquery-easyui-1.3.3/jquery.min.js"></script>
	<script type="text/javascript" src="/static/jquery-easyui-1.3.3/jquery.easyui.min.js"></script>
	<script type="text/javascript" src="/static/jquery-easyui-1.3.3/locale/easyui-lang-zh_CN.js"></script>

	<script type="text/javascript" src="/static/js/date.js"></script>
	<script type="text/javascript">


		function formatSupplier(val,row){
			return val.name;
		}

		function formatAmountPayable(val,row){
			return "￥"+val;
		}

		$(document).ready(function(){




			$("#s_bPurchaseDate").datebox("setValue",genLastMonthDayStr()); // 设置上个月日期
			$("#s_ePurchaseDate").datebox("setValue",genTodayStr()); // 设置当前日期


			$('#dg').datagrid({
				onClickRow: function(index,row){
					$("#dg2").datagrid({
						url:'/admin/purchaseList/listGoods',
						queryParams:{
							purchaseListId:row.id
						}
					});
				}
			});

		});

		function formatTotal(val,row){
			return "￥"+val.toFixed(2);
		}

		function formatPrice(val,row){
			return "￥"+val;
		}


		function searchPurchase(){
			$('#dg2').datagrid('loadData', { total: 0, rows: [] });
			var supplierId;
			if(isNaN($("#s_supplier").combobox("getValue"))){
				supplierId="";
			}else{
				supplierId=$("#s_supplier").combobox("getValue");
			}
			$("#dg").datagrid({
				url:'/admin/purchaseList/list',
				queryParams:{
					purchaseNumber:$("#s_purchaseNumber").val(),
					'supplier.id':supplierId,
					state:$("#s_state").combobox("getValue"),
					bPurchaseDate:$("#s_bPurchaseDate").datebox("getValue"),
					ePurchaseDate:$("#s_ePurchaseDate").datebox("getValue")
				}
			});
		}

		function deletePurchase(){
			var selectedRows=$("#dg").datagrid("getSelections");
			if(selectedRows.length!=1){
				$.messager.alert("系统提示","请选择要删除的进货单！");
				return;
			}
			var id=selectedRows[0].id;
			$.messager.confirm("系统提示","<font color=red>删除进货单后将无法恢复，是否删除？</font>",function(r){
				if(r){
					$.post("/admin/purchaseList/delete",{id:id},function(result){
						if(result.success){
							$("#dg").datagrid("reload");
							$("#dg2").datagrid("reload");
						}else{
							$.messager.alert("系统提示",result.errorInfo);
						}
					},"json");
				}
			});
		}

		function formatUser(val,row){
			return val.trueName;
		}

		function clearGrid(gridId){
			var item = $( '#'+gridId).datagrid('getRows');
			if (item) {
				for (var i = item.length - 1; i >= 0; i--) {
					var index = $( '#'+gridId).datagrid('getRowIndex', item[i]);
					$( '#'+gridId).datagrid('deleteRow', index);
				}
			}
		}

		function calculate(){
			var paybackDate = new Date($("#paybackDate").val()).getTime();
			leasebackPrice=$("#leasebackPrice").val();
			proposalId=$("#proposalId").val();

			clearGrid("dg");
			clearGrid("dg2");
			$.ajax({
				url: '/api/v1/pre_cal_basic_rent?leasebackPrice=' + leasebackPrice + '&paybackDate='+paybackDate+ '&proposalId='+proposalId,
				type: 'GET',
				contentType: 'application/json',
				success: function (data) {
						for(var i = 0; i<data.periodSumPayments.length;i++) {
							$('#dg').datagrid('appendRow', {
//								id:data[i].id,
								period:data.periodSumPayments[i].periodInfo.period,
								duration:data.periodSumPayments[i].periodInfo.duration,
								proportion:data.periodSumPayments[i].periodInfo.proportion,
								rentStartPayTime:getMoth(data.periodSumPayments[i].rentStartPayTime),
								rentEndPayTime:getMoth(data.periodSumPayments[i].rentEndPayTime),
								months:data.periodSumPayments[i].months,
								elevenMonthAmount:data.periodSumPayments[i].elevenMonthAmount,
								lastMonthAmount:data.periodSumPayments[i].lastMonthAmount,
								periodTotal:data.periodSumPayments[i].periodTotal
							});
						}
						for(var i = 0; i<data.result.length;i++) {
							$('#dg2').datagrid('appendRow', {
								period:data.result[i].calDtail.period,
								duration:data.result[i].calDtail.duration,
								proportion:data.result[i].calDtail.proportion,
								date:getMoth(data.result[i].date),
								amount:data.result[i].amount
							});
						}

				},
				error: function () {
					alert('An error has occured!! :-(')
				}
			})
		}

		function getMoth(str){
			var oDate = new Date(str),
					oYear = oDate.getFullYear(),
					oMonth = oDate.getMonth()+1,
					oDay = oDate.getDate(),
					oHours = oDate.getHours(),
					oMinutes = oDate.getMinutes(),
					oSeconds = oDate.getSeconds();
//			oTime =oYear+"-"+oMonth+"-"+oDay+" "+oHours+":"+oMinutes+":"+oSeconds;//最后拼接时间
			oTime =oYear+"-"+oMonth+"-"+oDay;//最后拼接时间
			return oTime;
		};
	</script>
</head>
<body class="easyui-layout" style="margin: 1px">
<div region="north" style="height: 200px;">
	<table id="dg"  class="easyui-datagrid" fit=true
		   fitColumns="true"  rownumbers="true" singleSelect="true"
		   toolbar="#tb" >
		<thead>
		<tr>
			<th field="id" width="30" align="center" hidden="true">进货单ID</th>
			<th field="period" width="30" align="center">期数</th>
			<th field="duration" width="30" align="center">持续时间</th>
			<th field="proportion" width="30" align="center">系数</th>
			<th field="rentStartPayTime" width="40" align="center">计租启始时间</th>
			<th field="rentEndPayTime" width="40" align="center">合同期</th>
			<th field="months" width="30" align="center">持续月数</th>
			<th field="elevenMonthAmount" width="30" align="center">平均月返租</th>
			<th field="lastMonthAmount" width="30" align="center">最后一月返租</th>
			<th field="periodTotal" width="30" align="center">金额(元)</th>
		</tr>
		</thead>
	</table>

	<div id="tb">
		<div style="padding-bottom: 5px">
			<fieldset style="border-color: #E7F0FF">
				<legend>查询设置</legend>
				&nbsp;回款时间&nbsp;<input type="text" id="paybackDate" name="paybackDate" required=false size="8" class="easyui-datebox" data-options="editable:false" value="2017-12-02"/>
				&nbsp;返租基价（元）&nbsp;<input type="text" id="leasebackPrice" name="contractNo" style="width: 90px;"/>
				<!--&nbsp;返租方案&nbsp;<input type="text" id="proposalId" name="contractNo" style="width: 90px;"/>-->
				<select class="easyui-combobox"   editable="false" style="width: 80px;" id="proposalId" name="proposalId" required="true" panelHeight="auto">
					<option value="1">方案一</option>
					<option value="2">方案二</option>
					<option value="3">方案三</option>
					<option value="4">方案四</option>
				</select>
				<a href="javascript:calculate()" class="easyui-linkbutton" iconCls="icon-ok" plain="true">计算</a>
			</fieldset>
		</div>
	</div>
</div>
<div region="center" style="margin-top: 5px;">
	<table id="dg2"  class="easyui-datagrid" fit=true
		   fitColumns="true"  rownumbers="true" singleSelect="true"
			>
		<thead>
		<tr>
			<th field="period" width="40" align="center">期数</th>
			<th field="duration" width="40" align="center">持续时间</th>
			<th field="proportion" width="40" align="center">系数</th>
			<th field="date" width="50" align="center" >返租日期</th>
			<th field="amount" width="50" align="center" >金额(元)</th>
		</tr>
		</thead>
	</table>
</div>
</body>
</html>




